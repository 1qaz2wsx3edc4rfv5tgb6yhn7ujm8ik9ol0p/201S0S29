header:set serveroutput off
header:set head off
header:set pagesize 0
header:set linesize 20000
header:set trimspool on
header:set trim on
header:set colsep ","
header:set termout off
header:set feedback off
header:set numwidth 15

alter session set nls_date_format = 'dd-Mon-yyyy hh24:mi:ss';
select 'SUBSCR_NO','EXTERNAL_ID_TO','DISPLAY_VALUE_TO','ACTIVE_DATE','EXTERNAL_ID_FROM','DISPLAY_VALUE_FROM','PARENT_ACCOUNT_NO','BILL_PERIOD','NEXT_BILL_DATE','OFFER_ID','OFFER_INST_ID','ACTIVE_DT','INACTIVE_DT','NEXT_BILL_DATE' from dual;

SELECT ciem1.subscr_no, ciem1.external_id external_id_to, '"'||ov1.display_value||'"' display_value_to, ciem1.active_date, ciem2.external_id external_id_from, '"'||ov2.display_value||'"' display_value_from, 
ss.parent_account_no, c.bill_period, c.next_bill_date, oiv3.offer_id, oiv3.offer_inst_id, oiv3.active_dt, oiv3.inactive_dt, c.next_bill_date
FROM customer_id_equip_map_view@cust1 ciem1, customer_id_equip_map_view@cust1 ciem2, subscriber_view@cust1 ss, cmf@cust1 c, offer_values@cust1 ov1, offer_values@cust1 ov2, offer_inst_view@cust1 oiv3
WHERE ciem1.external_id IN (
'115009','115035','115043','115090','115061','115122','115015','115028','115095','115107','115093','115092','115116','115010','115034','115044','102100','115052','115106','115091',
'115046','115060','115062','115117','115125','115008','115016','115029','115036','102037','115054','115123','115017','115023','115104','115124','115105','115094','115103','115007',
'115018','115042','115045','102506','115102','115053','115114','115115','102131','102231','102232','102016','102034','102035','102047','102086','102071','102201','102245','102260',
'102240','102285','102295','102015','102018','102025','102057','102061','102070','102082','102092','102202','102284','102013','102017','102019','102020','102021','102026','102048',
'102065','102085','115037','102198','102220','102227','102229','102283','102286','102014','102046','102087','102054','102055','102060','102064','102066','102072','102080','102075',
'102083','115032','102197','102218','102244','102293','102050','102053','102073','102076','102093','115025','102200','102261','102239','102294','102022','102023','102049','102045',
'102078','102219','102246','102228','102259','102230','102216','102062','102079','102081','115080','102199','102249','102051','102044','102063','102069','102074','102077','102084',
'115003','115004','115005','102091','115047','115048','115006','115002','115039','115070','115001','102259','102260','102261','102227','102228','102229','102230','102231','102232',
'102283','102284','102285','102286','102239','102240','102020','102021','102022','102023','102018','102019','102025','102026','102042','102043','102056','102058','102116','102233',
'102234','102236')
AND ciem1.external_id_type = 91 AND ciem1.view_status = 2 AND ciem1.active_date > To_Date('24-Feb-2015','dd-mon-yyyy')
AND (ciem1.inactive_date IS NULL OR ciem1.active_date <> ciem1.inactive_date) AND ciem2.subscr_no = ciem1.subscr_no
AND ciem2.external_id NOT IN (
'115009','115035','115043','115090','115061','115122','115015','115028','115095','115107','115093','115092','115116','115010','115034','115044','102100','115052','115106','115091',
'115046','115060','115062','115117','115125','115008','115016','115029','115036','102037','115054','115123','115017','115023','115104','115124','115105','115094','115103','115007',
'115018','115042','115045','102506','115102','115053','115114','115115','102131','102231','102232','102016','102034','102035','102047','102086','102071','102201','102245','102260',
'102240','102285','102295','102015','102018','102025','102057','102061','102070','102082','102092','102202','102284','102013','102017','102019','102020','102021','102026','102048',
'102065','102085','115037','102198','102220','102227','102229','102283','102286','102014','102046','102087','102054','102055','102060','102064','102066','102072','102080','102075',
'102083','115032','102197','102218','102244','102293','102050','102053','102073','102076','102093','115025','102200','102261','102239','102294','102022','102023','102049','102045',
'102078','102219','102246','102228','102259','102230','102216','102062','102079','102081','115080','102199','102249','102051','102044','102063','102069','102074','102077','102084',
'115003','115004','115005','102091','115047','115048','115006','115002','115039','115070','115001','102259','102260','102261','102227','102228','102229','102230','102231','102232',
'102283','102284','102285','102286','102239','102240','102020','102021','102022','102023','102018','102019','102025','102026','102042','102043','102056','102058','102116','102233',
'102234','102236')
AND ciem2.external_id_type = 91 AND ciem2.view_status = 2 AND ciem2.active_date <> ciem2.inactive_date AND ciem2.inactive_date = ciem1.active_date
AND ss.subscr_no = ciem1.subscr_no AND ss.view_status = 2 AND c.account_no = ss.parent_account_no
AND ov1.offer_id = ciem1.external_id AND ov1.reseller_version_id = 39 AND ov2.offer_id = ciem2.external_id AND ov2.reseller_version_id = 39
AND EXISTS (SELECT 1 FROM offer_inst_view@cust1 oiv2 WHERE oiv2.subscr_no = ciem2.subscr_no AND oiv2.offer_id = 10624 AND oiv2.view_status = 2
AND oiv2.active_dt > To_Date('23-Feb-2015','dd-mon-yyyy'))
AND oiv3.subscr_no = ciem2.subscr_no AND oiv3.offer_id = 10624 AND oiv3.view_status = 2 AND oiv3.active_dt > To_Date('23-Feb-2015','dd-mon-yyyy')
AND c.bill_period IN (
(select 'M'||extract(day from sysdate) from dual), (select 'C'||extract(day from sysdate) from dual)
)
AND ciem1.active_date >= add_months(trunc(sysdate),-1)+1;